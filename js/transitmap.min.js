$(document).ready(function(){function p(){t.clearRect(0,0,n,r);t.beginPath()}function d(e,n){t.fillStyle="#000";t.beginPath();var r=0;for(var i=.5;i<c;i+=n){t.moveTo(i,0);t.lineTo(i,h)}t.moveTo(c-.5,0);t.lineTo(c-.5,h);r=0;for(var s=.5;s<h;s+=n){t.moveTo(0,s);t.lineTo(c,s)}t.moveTo(0,h-.5);t.lineTo(c,h-.5);t.strokeStyle="#eee";t.lineWidth=1;t.stroke();t.fill();t.closePath()}function v(n,r,i,s,o,u){t.beginPath();t.moveTo(u[0].x*n,u[0].y*n);var a=[],f=[],l;for(l=0;l<u.length;l++)u[l].marker.indexOf("@")!=0&&(f[f.length]=u[l]);for(var c=0;c<f.length;c++)if(c<f.length-1){var h=f[c+1],p=f[c],d=0,v=0;h.x==0&&(d=o/2);h.x==i&&(d=-1*o/2);h.y==0&&(v=o/2);h.y==r&&(v=-1*o/2);var g=0,y=0,b="",w=Math.round(Math.abs(p.x-h.x)),E=Math.round(Math.abs(p.y-h.y));if(w==0||E==0)t.lineTo(h.x*n+d,h.y*n+v);else if(w==1&&E==1){if(h.direction!=""){b=h.direction.toLowerCase();switch(b){case"s":g=0;y=n;break;case"e":g=n;y=0;break;case"w":g=-1*n;y=0;break;default:g=0;y=-1*n}t.quadraticCurveTo(p.x*n+g,p.y*n+y,h.x*n+d,h.y*n+v)}}else if(w==E){h.x<p.x?h.y<p.y?b="nw":b="sw":h.y<p.y?b="ne":b="se";var S=1;switch(b){case"nw":g=-1*(n/2);y=1;S=1;break;case"sw":g=-1*(n/2);y=-1;S=1;break;case"se":g=n/2;y=-1;S=-1;break;case"ne":g=n/2;y=1;S=-1}t.bezierCurveTo(p.x*n+g,p.y*n,p.x*n+g,p.y*n,(h.x+S*w/2)*n,(h.y+y*w/2)*n);t.bezierCurveTo(h.x*n+S*n/2,h.y*n,h.x*n+S*n/2,h.y*n,h.x*n,h.y*n)}else t.lineTo(h.x*n,h.y*n)}t.strokeStyle=s;t.lineWidth=o;t.stroke();for(l=0;l<u.length;l++)m(e,t,n,s,o,u[l])}function m(e,t,n,r,i,s){if(s.label=="")return;s.marker==""&&(s.marker="station");var o=s.x*n,u=s.y*n,a="#000000",f="#FFFFFF";t.strokeStyle=a;t.fillStyle=f;t.beginPath();switch(s.marker.toLowerCase()){case"interchange":case"@interchange":t.lineWidth=i;if(s.markerInfo=="")t.arc(o,u,i*.7,0,Math.PI*2,!0);else{var l=s.markerInfo.substr(0,1).toLowerCase(),c=parseInt(s.markerInfo.substr(1,10));if((l=="v"||l=="h")&&c>1)if(l=="v"){t.arc(o,u,i*.7,290*Math.PI/180,250*Math.PI/180,!1);t.arc(o,u-i*c,i*.7,110*Math.PI/180,70*Math.PI/180,!1)}else{t.arc(o,u,i*.7,20*Math.PI/180,340*Math.PI/180,!1);t.arc(o+i*c,u,i*.7,200*Math.PI/180,160*Math.PI/180,!1)}else t.arc(o,u,i*.7,0,Math.PI*2,!0)}break;case"station":case"@station":t.lineWidth=i/2;t.arc(o,u,i/2,0,Math.PI*2,!0)}t.closePath();t.stroke();t.fill();var h="",p="",d=20,v=0,m=-50;switch(s.labelPos.toLowerCase()){case"n":h="center";p="0px 0px "+d+"px "+m+"px";v=d*2;break;case"w":h="right";p="0px "+d+"px 0 -"+(100+d)+"px";v=d;break;case"e":h="left";p="0px 0px 0px "+d+"px";v=d;break;case"s":h="center";p=d+"px 0px 0px "+m+"px"}var g="text-align:"+h+"; "+"margin:"+p+"; "+"top:"+(u+e.offset().top-(v>0?v:0))+"px; "+"left:"+(o+e.offset().left)+"px; ",y='<a class="text" style="'+g+'" rel="tooltip" title="'+s.label.replace(/\\n/g,"<br />")+'" href="'+s.link+'">'+s.label.replace(/\\n/g,"<br />")+"</span>";$(y).prependTo(document.body)}function g(){$("ul").each(function(e){var t=$(this),n=$(t).attr("data-color"),r=$(t).attr("data-label");$("#legend").append('<div class="legend-label"><span class="legend-line" style="height:'+f+"px; background-color:"+n+'"></span>'+r+"</div>");var i=0,s=0,l=[];$(t).children("li").each(function(){var e=$(this).attr("data-coords"),t=$(this).attr("data-direction");t===undefined&&(t="");var n=$(this).attr("data-label-position");n===undefined&&(n="s");var r=$(this).attr("data-marker");r==undefined&&(r="");var o=$(this).attr("data-marker-info");o==undefined&&(o="");var u=$(this).children("a:first-child"),a=$(this).text();a===undefined&&(a="");var f="",c="";if(u!=undefined){f=$(u).attr("href");f===undefined&&(f="");c=$(u).attr("title");c===undefined&&(c="")}var h="",p="";if(e.indexOf(",")>-1){h=Number(e.split(",")[0])+(r.indexOf("interchange")>-1?0:i);p=Number(e.split(",")[1])+(r.indexOf("interchange")>-1?0:s)}l[l.length]={x:h,y:p,direction:t,marker:r,markerInfo:o,link:f,title:c,label:a,labelPos:n}});l.length>0&&v(a,o,u,n,f,l);$(t).remove()})}var e=$("#canvas"),t=e.get(0).getContext("2d"),n=e.width(),r=e.height(),i=e.width/2,s=e.height/2,o=e.attr("data-rows"),u=e.attr("data-columns"),a=e.attr("data-scale"),f=e.attr("data-line-width"),l=[],c=u*a,h=o*a;$(e).removeClass("loading");g()});